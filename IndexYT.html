
<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">
  <title>My first leaflet map</title>

  <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css" />
  <script src="./leaflet.ajax.min.js"></script>
  <script src="./Data/stationwise_aggregates.js"></script>
  <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
  <script src="http://d3plus.org/js/d3.js"></script>
  <script src="L.D3SvgOverlay.min.js"></script>



  <script src="./Data/gis/bsd.js"></script>




  <style>

    #mapContainer {
      position: absolute;
      left: 400px;
      width: 80%;
      height: 80%;
      z-index: -1;
    }

    #viz-container{
        position: absolute;
        margin: 0 auto;
        background: white;
        width: 400px;
        height: 200px;
        z-index:-2;
    }

    #svg{
      position: absolute;
    }

    path {
        stroke: steelblue;
        stroke-width: 2;
        fill: none;
    }

    .axis path,
    .axis line {
        fill: none;
        stroke: grey;
        stroke-width: 1;
        shape-rendering: crispEdges;
    }

  </style>

</head>

<body>


  <div id = "mapContainer"></div>
  <div id="viz-container"></div>

  <script>
      var station_id = 1;

      var map = L.map('mapContainer').setView([42.3581,-71.093198], 14);
      var layer = L.tileLayer('https://{s}.tile.openstreetmap.se/hydda/full/{z}/{x}/{y}.png', {
        attribuation: '&copy; <a href="http://www.openstreetmap.org/copyright> OpenSteetMap<a> contributors, &copy; <a href="https://carto.com/ attribuations">CARTO</a>'
      }).addTo(map);

      L.geoJson(stationdata, {
      		  pointToLayer: function (feature, latlng) {
      		    	var popupOptions = { maxWidth: 200 };
      		        var popupContent = "Station: " + feature.properties.station_name + "</br>" + "Trip Starts:" + feature.properties.trip_starts;

      		    function getOptions(properties) {
                return {
                  radius: properties.trip_ends/1000,
                  color: "black",
                  fillColor: "#000000"
                };
      		    }
      		    return L.circleMarker(latlng, getOptions(feature.properties)).bindPopup(popupContent, popupOptions);
      		  }
      		}).addTo(map);

      var popup = L.popup()
          .setLatLng([42.3581,-71.093198])
          .setContent("MIT here")
          .openOn(map);

//changing the attributes of lines is not working :(
      var flows = [];
      var flowPaths = L.d3SvgOverlay(function(sel, proj) {

          var upd = sel.selectAll('path').data(flows);
          upd.enter()
            .append('path')
            .attr('d', proj.pathFromGeojson)
            .attr('stroke', 'black')
            .attr('fill-opacity', '0.5');
          upd.attr('stroke-width', 1 / proj.scale);
      });

      L.control.layers({"Geo Tiles": layer}, {"Countries": flowPaths}).addTo(map);

      d3.json("./Data/flows/flowpairs_1.geo.json", function(data) { flows = data.features; flowPaths.addTo(map) });
/*
      L.geoJson(flowdata, {
            linetoLayer: function (feature, latlng) {

              function getOptions(properties) {
                return {
                  weight: properties.Flow/1000,
                  color: "black",
                };
              }
              return L.path(latlng, getOptions(feature.properties));
            }
          }).addTo(map);
*/
        // Set the dimensions of the canvas / graph
        var margin = {top: 40, right: 40, bottom: 40, left: 40},
            width = 400 - margin.left - margin.right,
            height = 400 - margin.top - margin.bottom-50;

        // Parse the date / time
        var parseDate = d3.time.format("%d-%b-%y").parse;

        // Set the ranges
        var x = d3.scale.linear().range([0, width-margin.right]);
        var y = d3.scale.linear().range([height-margin.top, 0]);

        // Define the axes
        var xAxis = d3.svg.axis().scale(x)
            .orient("bottom").ticks(24);

        var yAxis = d3.svg.axis().scale(y)
            .orient("left").ticks(10);

        // Define the line
        var startsLine = d3.svg.line()
            .x(function(d) { return x(d.hour); })
            .y(function(d) { return y(d.starts); });
      //      .attr("stroke": "green"); how to change color?

        var endsLine = d3.svg.line()
            .x(function(d) { return x(d.hour); })
            .y(function(d) { return y(d.ends); });

        // Adds the svg canvas
        var svg = d3.select("#viz-container").append("svg")
        //    .append("svg")
                .attr("width", width)
                .attr("height", height)
                .attr("fill",  "#000000")
                .attr("padding-top", 20)
                .attr("padding-bottom",20)
                .attr("background-color", "black")
            .append("g")
                .attr("transform",
                      "translate(" + margin.left + "," + margin.top + ")");

        // Get the data
        var path = "./Data/stationflow/stationflow_" + station_id + ".csv" //just need to change this path in order to change graph
        d3.csv(path , function(error, data) {
            data.forEach(function(d) {
                d.hour = +d.hour;
                d.starts = +d.starts;
                d.ends = +d.ends;
            });

            // Scale the range of the data
            x.domain(d3.extent(data, function(d) { return d.hour; }));
            y.domain([d3.min(data, function(d) { return d.starts; }), d3.max(data, function(d) { return d.ends; })]);

            // Add the valueline path.
            svg.append("path")
                .attr("class", "line")
  //              .attr(stroke, "red")
                .attr("d", startsLine(data));

            svg.append("path")
                .attr("class", "line")
                .attr("d", endsLine(data));

            // Add the X Axis
            svg.append("g")
                .attr("class", "x axis")
                .attr("transform", "translate(0," + height + ")")
                .call(xAxis);

            // Add the Y Axis
            svg.append("g")
                .attr("class", "y axis")
                .call(yAxis);

        });


              L.geoJson(bsd, {
              		  pointToLayer: function (feature, latlng) {
              		    	var popupOptions = { maxWidth: 200 };
              		        var popupContent = "Station: " + feature.properties.station_name + "</br>" + "Trip Starts:" + feature.properties.trip_starts;

              		    function getOptions(properties) {
                        return {
                          radius: properties.trip_ends/1000,
                          color: "black",
                          fillColor: "#000000"
                        };
              		    }
              		    return L.circleMarker(latlng, getOptions(feature.properties)).bindPopup(popupContent, popupOptions);
              		  }
              		}).addTo(map);

    </script>

</body>
</html>
